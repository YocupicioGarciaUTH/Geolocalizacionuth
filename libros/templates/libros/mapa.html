<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Bibliotecas</title>
    
    <!-- Estilos CSS -->
    <style>
        /* Resetear estilos por defecto */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }
        
        /* Contenedor principal */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        /* Encabezado */
        .header {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        /* El mapa ocupar√° 600px de alto y todo el ancho */
        #map {
            height: 600px;
            width: 100%;
        }
        
        /* Panel de informaci√≥n */
        .info-panel {
            padding: 20px;
            background: #f8f9fa;
        }
        
        /* Botones */
        .btn {
            background: #11998e;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        
        .btn:hover {
            background: #0d7a6f;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Encabezado -->
        <div class="header">
            <h1>üó∫Ô∏è Mapa de Bibliotecas de M√©xico</h1>
            <p>Encuentra la biblioteca m√°s cercana</p>
        </div>
        
        <!-- Panel de controles -->
        <div class="info-panel">
            <button class="btn" onclick="obtenerMiUbicacion()">
                üìç Usar mi ubicaci√≥n actual
            </button>
            <button class="btn" onclick="cargarBibliotecas()">
                üîÑ Recargar bibliotecas
            </button>
            <span id="contador" style="margin-left: 20px; font-weight: bold;">
                Bibliotecas cargadas: 0
            </span>
        </div>
        
        <!-- Contenedor del mapa (aqu√≠ se mostrar√° Google Maps) -->
        <div id="map"></div>
    </div>
    
    <!-- Cargar la API de Google Maps -->
    <!-- IMPORTANTE: Reemplaza TU_API_KEY con tu clave real -->
    <script src=https://maps.googleapis.com/maps/api/js?key=AIzaSyC6E_Zg4-D_9ffVO-BCmi1-SdmWXpQ0GCg&callback=initMap
            async defer></script>
    
    <!-- JavaScript para controlar el mapa -->
    <script>
        // ========================================
        // VARIABLES GLOBALES
        // ========================================
        
        let map;  // Variable que guardar√° el objeto del mapa
        let markers = [];  // Array para guardar todos los marcadores
        
        // ========================================
        // FUNCI√ìN 1: Inicializar el mapa
        // Se ejecuta autom√°ticamente cuando carga Google Maps
        // ========================================
        
        function initMap() {
            console.log('üó∫Ô∏è Inicializando mapa...');
            
            // Crear el mapa centrado en Ciudad de M√©xico, M√©xico
            map = new google.maps.Map(document.getElementById('map'), {
                center: { 
                    lat: 19.4326,   // Latitud de Ciudad de M√©xico
                    lng: -99.1332   // Longitud de Ciudad de M√©xico
                },
                zoom: 4,  // Nivel de zoom (1 = mundo, 20 = edificio)
                
                // Opciones adicionales del mapa
                mapTypeControl: true,  // Mostrar bot√≥n para cambiar tipo de mapa
                streetViewControl: true,  // Mostrar bot√≥n Street View
                fullscreenControl: true,  // Bot√≥n de pantalla completa
                zoomControl: true  // Botones de zoom +/-
            });
            
            // Cargar las bibliotecas autom√°ticamente al iniciar
            cargarBibliotecas();
        }
        
        // ========================================
        // FUNCI√ìN 2: Cargar bibliotecas desde la API
        // ========================================
        
        async function cargarBibliotecas() {
            console.log('üìö Cargando bibliotecas desde la API...');
            
            try {
                // Hacer petici√≥n GET a nuestra API
                const response = await fetch('/api/bibliotecas/');
                
                // Verificar si la petici√≥n fue exitosa
                if (!response.ok) {
                    throw new Error('Error en la petici√≥n: ' + response.status);
                }
                
                // Convertir la respuesta a JSON
                const data = await response.json();
                
                console.log('‚úÖ Datos recibidos:', data);
                
                // Limpiar marcadores anteriores
                limpiarMarcadores();
                
                // Contador de bibliotecas
                let contador = 0;
                
                // Crear un marcador para cada biblioteca
                data.forEach(biblioteca => {
                    // Solo crear marcador si tiene coordenadas
                    if (biblioteca.latitud && biblioteca.longitud) {
                        crearMarcador(biblioteca);
                        contador++;
                    }
                });
                
                // Actualizar contador en la p√°gina
                document.getElementById('contador').textContent = 
                    `Bibliotecas cargadas: ${contador}`;
                
            } catch (error) {
                console.error('‚ùå Error cargando bibliotecas:', error);
                alert('Error al cargar las bibliotecas. Verifica la consola.');
            }
        }
        
        // ========================================
        // FUNCI√ìN 3: Crear marcador en el mapa
        // ========================================
        
        function crearMarcador(biblioteca) {
            // Crear el marcador (pin) en el mapa
            const marker = new google.maps.Marker({
                position: {
                    lat: parseFloat(biblioteca.latitud),  // Convertir string a n√∫mero
                    lng: parseFloat(biblioteca.longitud)
                },
                map: map,  // En qu√© mapa mostrarlo
                title: biblioteca.nombre,  // Texto al pasar el mouse
                animation: google.maps.Animation.DROP  // Animaci√≥n de ca√≠da
            });
            
            // Crear ventana de informaci√≥n (popup)
            const infoWindow = new google.maps.InfoWindow({
                content: `
                    <div style="padding: 10px; max-width: 250px;">
                        <h3 style="margin: 0 0 10px 0; color: #11998e;">
                            ${biblioteca.nombre}
                        </h3>
                        <p style="margin: 5px 0;">
                            <strong>üìç Direcci√≥n:</strong><br>
                            ${biblioteca.direccion}<br>
                            ${biblioteca.ciudad}, ${biblioteca.pais}
                        </p>
                        <p style="margin: 5px 0;">
                            <strong>üìû Tel√©fono:</strong><br>
                            ${biblioteca.telefono || 'No disponible'}
                        </p>
                        <p style="margin: 5px 0;">
                            <strong>üïí Horario:</strong><br>
                            ${biblioteca.horario || 'No disponible'}
                        </p>
                        <p style="margin: 10px 0 0 0; font-size: 0.9em; color: #666;">
                            <strong>Coordenadas:</strong><br>
                            ${biblioteca.latitud}, ${biblioteca.longitud}
                        </p>
                        ${biblioteca.google_maps_url ? `
                            <p style="margin: 10px 0 0 0; text-align: center;">
                                <a href="${biblioteca.google_maps_url}" 
                                   target="_blank" 
                                   style="display: inline-block; 
                                          background: #11998e; 
                                          color: white; 
                                          padding: 8px 15px; 
                                          text-decoration: none; 
                                          border-radius: 5px;
                                          font-weight: bold;">
                                    üó∫Ô∏è Abrir en Google Maps
                                </a>
                            </p>
                        ` : ''}
                    </div>
                `
            });
            
            // Al hacer clic en el marcador, mostrar la informaci√≥n
            marker.addListener('click', () => {
                // Cerrar todas las ventanas abiertas
                markers.forEach(m => {
                    if (m.infoWindow) {
                        m.infoWindow.close();
                    }
                });
                
                // Abrir esta ventana
                infoWindow.open(map, marker);
                
                // Centrar el mapa en este marcador
                map.setCenter(marker.getPosition());
            });
            
            // Guardar referencia a la ventana de informaci√≥n
            marker.infoWindow = infoWindow;
            
            // Agregar el marcador al array
            markers.push(marker);
        }
        
        // ========================================
        // FUNCI√ìN 4: Obtener ubicaci√≥n del usuario
        // ========================================
        
        function obtenerMiUbicacion() {
            console.log('üìç Obteniendo ubicaci√≥n del usuario...');
            
            // Verificar si el navegador soporta geolocalizaci√≥n
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    // √âxito: se obtuvo la ubicaci√≥n
                    (position) => {
                        const pos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        console.log('‚úÖ Ubicaci√≥n obtenida:', pos);
                        
                        // Centrar el mapa en la ubicaci√≥n del usuario
                        map.setCenter(pos);
                        map.setZoom(15);
                        
                        // Crear marcador "Estoy aqu√≠"
                        new google.maps.Marker({
                            position: pos,
                            map: map,
                            title: 'Mi ubicaci√≥n',
                            icon: {
                                url: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
                            }
                        });
                    },
                    // Error: no se pudo obtener la ubicaci√≥n
                    (error) => {
                        console.error('‚ùå Error obteniendo ubicaci√≥n:', error);
                        alert('No se pudo obtener tu ubicaci√≥n. Verifica los permisos.');
                    }
                );
            } else {
                alert('Tu navegador no soporta geolocalizaci√≥n');
            }
        }
        
        // ========================================
        // FUNCI√ìN 5: Limpiar todos los marcadores
        // ========================================
        
        function limpiarMarcadores() {
            // Remover cada marcador del mapa
            markers.forEach(marker => {
                marker.setMap(null);
            });
            
            // Vaciar el array
            markers = [];
        }
        
    </script>
</body>
</html>